{% trans_default_domain 'front_default' %}

{% import _self as macro %}

{% set itemsPerSlide = itemsPerSlide is defined ? itemsPerSlide : 4 %}
{% set entities = associatedEntities.list %}
{% set fade = 'loop' %}
{% set arrowsAlignment = 'top-end' %}
{% set arrows = entities|length > 1 %}
{% set arrowsSide = 'end' in arrowsAlignment ? 'end' : 'start' %}
{% set arrowsColor = 'primary' %}
{% set arrowsAsBtn = true %}
{% set currentZone = block.col.zone is defined ? block.col.zone : null %}
{% set currentZoneBg = currentZone.backgroundColor is defined and currentZone.backgroundColor
    ? currentZone.backgroundColor : (currentZone.customClass is defined ? currentZone.customClass : null) %}
{% set grayColor = 'bg-primary' == currentZoneBg or 'bg-video' == currentZoneBg %}
{% set displayIndexLInk = true %}
{% set disabledTitle = disabledTitle is defined ? disabledTitle : false %}
{% set listingTitle = listingTitle is defined and listingTitle ? listingTitle : "Découvrez également"|trans %}

{% macro arrows(entity, autoplay, side, color, asBtn, position) %}
    {% set website = entity.website is defined ? entity.website : website() %}
    {% set configuration = website.configuration is defined ? website.configuration : false %}
    {% set accessibility = configuration.accessibilityStatus is defined ? configuration.accessibilityStatus : true %}
    {% set iconClasses = not asBtn ? 'text-'~color : '' %}
    {% set icon = asBtn ? 'chevron' : 'arrow' %}
    {% set btnClasses = asBtn ? 'btn-circle btn btn-'~color : '' %}
    <div class="arrows-wrap d-flex justify-content-{{ side }} {% if 'top' == position %}mb-5{% else %}mt-5{% endif %}{% if 'end' == side %} me-4 me-md-5{% endif %}{% if asBtn %} as-btn{% endif %}">
        <button class="btn-arrow btn-prev cursor{% if btnClasses %} {{ btnClasses }}{% endif %} me-2" aria-label="{{ "Précédent"|trans }}">
            <i class="icon-{{ icon }}-left{% if iconClasses %} {{ iconClasses }}{% endif %}"></i>
        </button>
        {% if autoplay and accessibility %}
            <button class="btn-arrow btn-pause cursor{% if btnClasses %} {{ btnClasses }}{% endif %} mx-1" aria-label="{{ "Pause"|trans }}" tabindex="-1">
                <i class="icon-pause{% if iconClasses %} {{ iconClasses }}{% endif %}"></i>
            </button>
            <button class="btn-arrow btn-play d-none cursor{% if btnClasses %} {{ btnClasses }}{% endif %} mx-1" aria-label="{{ "Play"|trans }}" tabindex="-1">
                <i class="icon-play{% if iconClasses %} {{ iconClasses }}{% endif %}"></i>
            </button>
        {% endif %}
        <button class="btn-arrow btn-next cursor{% if btnClasses %} {{ btnClasses }}{% endif %} ms-2" aria-label="{{ "Suivant"|trans }}">
            <i class="icon-{{ icon }}-right{% if iconClasses %} {{ iconClasses }}{% endif %}"></i>
        </button>
    </div>
{% endmacro %}

<div class="slider-container{% if entities is empty %} empty-associated-entities{% endif %}">
    {% if not disabledTitle %}
        <div class="title-block w-100 mb-5">
            <h2 class="title">{{ listingTitle|raw }}</h2>
        </div>
    {% endif %}
    {% set autoplay = 1 %}
    <div class="splide{% if not arrows %} no-arrows{% endif %}"
         data-lenght="{{ entities|length }}"
         data-items="{{ itemsPerSlide }}"
         data-items-medium-pc="3"
         data-items-mini-pc="3"
         data-items-tablet="2"
         data-items-mobile="1"
         data-fade="fade"
         data-scroll="{{ itemsPerSlide }}"
         data-pause="1"
         data-autoplay="{{ autoplay }}"
         data-arrows="{{ entities|length > 1 }}"
         data-dots="0"
         data-offset="150"
         data-offset-medium-pc="50"
         data-offset-mini-pc="50"
         data-offset-tablet="50"
         data-offset-mobile="50"
         data-interval="2500">
        <div class="splide__track">
            {% if arrows and 'top' in arrowsAlignment %}
                {{ macro.arrows(entity, autoplay, arrowsSide, arrowsColor, arrowsAsBtn, 'top') }}
            {% endif %}
            <ul class="splide__list">
                {% set isFirst = true %}
                {% for entity in entities %}
                    {% set media = entity.mainMedia %}
                    <li class="splide__slide">
                        <div class="ms-4 ms-md-5">
                            <a href="{{ entity.url }}" class="d-inline-block slider-link">
                                <div class="media-wrap">
                                    {{ media|file({}, {
                                        notInBox: true,
                                        maxWidth: null,
                                        maxHeight: 200 }) }}
                                </div>
                                {% if entity.intl.title or entity.intl.body or entity.intl.introduction %}
                                    <div class="content d-flex mt-4 pt-3 pe-3">
                                        <div class="inner">
                                            {% if entity.intl.title %}
                                                <h3 class="title fw-600 mb-3 mb-md-4">{{ entity.intl.title|raw }}</h3>
                                            {% endif %}
                                            {% if entity.intl.introduction %}
                                                <p class="introduction text-warning">{{ entity.intl.introduction|raw|nl2br }}</p>
                                            {% endif %}
                                        </div>
                                    </div>
                                {% endif %}
                            </a>
                        </div>
                    </li>
                {% endfor %}
            </ul>
            {% if arrows and 'bottom' in arrowsAlignment %}
                {{ macro.arrows(entity, autoplay, arrowsSide, arrowsColor, arrowsAsBtn, 'bottom') }}
            {% endif %}
        </div>
        {% if entities|length > 1 %}
            <div class="row">
                <div class="col-11 col-md-9">
                    <div class="slider-progress-container d-flex justify-content-start align-items-center w-100 mt-5">
                        <div class="slider-progress w-100">
                            <div class="slider-progress-bar"></div>
                        </div>
                    </div>
                </div>
            </div>
        {% endif %}
    </div>
    {% if not displayIndexLInk and pageUrl %}
        {% set btnLabel = entity.category.intl.placeholder is defined and entity.category.intl.placeholder ? entity.category.intl.placeholder : "Toutes les publications"|trans %}
        <div class="d-flex justify-content-center mt-5">
            {% include 'front/'~websiteTemplate~'/blocks/link/default.html.twig' with {
                intl: {
                    link: path('front_index', {url: pageUrl}),
                    linkStyle: 'btn btn-primary',
                    linkLabel: btnLabel,
                }
            } %}
        </div>
    {% endif %}
</div>