{% trans_default_domain 'front_default' %}

{% import _self as macro %}

{% set itemsPerSlide = itemsPerSlide is defined ? itemsPerSlide : 4 %}
{% set entities = associatedEntities.list %}
{% set fade = 'loop' %}
{% set arrowsAlignment = 'top-end' %}
{% set arrows = entities|length > 1 %}
{% set arrowsSide = 'end' in arrowsAlignment ? 'end' : 'start' %}
{% set arrowsColor = 'primary' %}
{% set arrowsAsBtn = true %}
{% set currentZone = block.col.zone is defined ? block.col.zone : null %}
{% set currentZoneBg = currentZone.backgroundColor is defined and currentZone.backgroundColor
    ? currentZone.backgroundColor : (currentZone.customClass is defined ? currentZone.customClass : null) %}
{% set grayColor = 'bg-primary' == currentZoneBg or 'bg-video' == currentZoneBg %}
{% set displayIndexLInk = true %}
{% set disabledTitle = disabledTitle is defined ? disabledTitle : false %}
{% set listingTitle = listingTitle is defined and listingTitle ? listingTitle : "Découvrez également"|trans %}
{% set thumbConfiguration = associatedEntitiesThumbConfiguration is defined ? associatedEntitiesThumbConfiguration : (thumbConfiguration is defined ? thumbConfiguration : []) %}
{% set isMobile = isMobile() %}
{% set promoteFirst = false %}

{% macro mediaRelation(entity, thumbConfiguration) %}
    {{ entity.mainMedia|file(thumbConfiguration, {
        btnLink: false,
        isInBox: true,
        targetLink: entity.url is defined ? entity.url : false,
        popupGallery: false,
        fullPopup: false,
        placeholder: true,
        lazyLoad: true,
        class: 'w-100'
    }) }}
{% endmacro %}

{% macro body(entity) %}
    <h3 class="title mb-4"><a href="{{ entity.url }}" class="title-link fw-600">{{ entity.intl.title|raw }}</a></h3>
{% endmacro %}

{% macro arrows(entity, autoplay, side, color, asBtn, position) %}
    {% set website = entity.website is defined ? entity.website : website() %}
    {% set configuration = website.configuration is defined ? website.configuration : false %}
    {% set accessibility = configuration.accessibilityStatus is defined ? configuration.accessibilityStatus : true %}
    {% set iconClasses = not asBtn ? 'text-'~color : '' %}
    {% set icon = asBtn ? 'chevron' : 'arrow' %}
    {% set btnClasses = asBtn ? 'btn-circle btn btn-'~color : '' %}
    <div class="arrows-wrap d-flex justify-content-{{ side }} {% if 'top' == position %}mb-4 mb-lg-5{% else %}mt-5{% endif %}{% if 'end' == side %} me-4 me-md-5{% endif %}{% if asBtn %} as-btn{% endif %}">
        <button class="btn-arrow btn-prev cursor{% if btnClasses %} {{ btnClasses }}{% endif %} me-2" aria-label="{{ "Précédent"|trans }}">
            <i class="icon-{{ icon }}-left{% if iconClasses %} {{ iconClasses }}{% endif %}"></i>
        </button>
        {% if autoplay and accessibility %}
            <button class="btn-arrow btn-pause cursor{% if btnClasses %} {{ btnClasses }}{% endif %} mx-1" aria-label="{{ "Pause"|trans }}" tabindex="-1">
                <i class="icon-pause{% if iconClasses %} {{ iconClasses }}{% endif %}"></i>
            </button>
            <button class="btn-arrow btn-play d-none cursor{% if btnClasses %} {{ btnClasses }}{% endif %} mx-1" aria-label="{{ "Play"|trans }}" tabindex="-1">
                <i class="icon-play{% if iconClasses %} {{ iconClasses }}{% endif %}"></i>
            </button>
        {% endif %}
        <button class="btn-arrow btn-next cursor{% if btnClasses %} {{ btnClasses }}{% endif %} ms-2" aria-label="{{ "Suivant"|trans }}">
            <i class="icon-{{ icon }}-right{% if iconClasses %} {{ iconClasses }}{% endif %}"></i>
        </button>
    </div>
{% endmacro %}

{% macro showLink(websiteTemplate, entity) %}
    {% include 'front/'~websiteTemplate~'/blocks/link/default.html.twig' with {intl: {link: entity.url}} %}
{% endmacro %}

<div class="slider-container{% if entities is empty %} empty-associated-entities{% endif %}">
    {% if not disabledTitle %}
        <div class="title-block w-100 mb-4 mb-lg-3">
            <h2 class="title">{{ listingTitle|raw }}</h2>
        </div>
    {% endif %}
    {% set autoplay = 1 %}
    <div class="splide{% if not arrows %} no-arrows{% endif %}"
         data-items="{{ itemsPerSlide }}"
         data-lenght="{{ entities|length }}"
         data-items-medium-pc="3"
         data-items-mini-pc="3"
         data-items-tablet="2"
         data-items-mobile="1"
         data-fade="loop"
         data-scroll="1"
         data-pause="1"
         data-autoplay="{{ autoplay }}"
         data-arrows="1"
         data-dots="0"
         data-gap="2rem"
         data-counter="0"
         data-interval="2500">
        <div class="splide__track">
            {% if arrows and 'top' in arrowsAlignment %}
                {{ macro.arrows(entity, autoplay, arrowsSide, arrowsColor, arrowsAsBtn, 'top') }}
            {% endif %}
            <ul class="splide__list">
                {% set isFirst = true %}
                {% for entity in entities %}
                    {% set isFirst = loop.index == 1 %}
                    {% set colSizeNext = promoteFirst ? (100 - colSizeFirst) / (teaser.itemsPerSlide - 1) : null %}
                    {% set colSizeNext = isMobile ? 100 : (isTablet() ? 40 : colSizeNext) %}
                    {% set colSize = promoteFirst and not isFirst ? colSizeNext : (promoteFirst ? colSizeFirst : null) %}
                    <li class="splide__slide ps-0 pe-0 ps-md-0 pe-md-4 {% if isMobile %}col-12{% else %}col{% if not promoteFirst %}-md-4{% endif %}{% endif %}{% if loop.index > itemsPerSlide %} d-none{% endif %}{% if isFirst %} is-first{% endif %}"
                        {% if colSizeNext %}data-size-next="{{ colSizeNext }}%"{% endif %}
                            {% if colSize %}style="width: {{ colSize }}%"{% endif %}>
                        <div class="card bg-transparent d-inline-block border-0 w-100">
                            <div class="card-header bg-transparent p-0 border-0">
                                {{ macro.mediaRelation(entity, thumbConfiguration) }}
                            </div>
                            <div class="card-body bg-transparent p-0 border-0 pt-4">
                                {{ macro.body(entity) }}
                            </div>
                            <div class="card-footer bg-transparent p-0 border-0 pt-3">
                                {{ macro.showLink(websiteTemplate, entity) }}
                            </div>
                        </div>
                    </li>
                {% endfor %}
            </ul>
            {% if arrows and 'bottom' in arrowsAlignment %}
                {{ macro.arrows(entity, autoplay, arrowsSide, arrowsColor, arrowsAsBtn, 'bottom') }}
            {% endif %}
        </div>
        {% if entities|length > 1 %}
            <div class="row">
                <div class="col-11 col-md-9">
                    <div class="slider-progress-container d-flex justify-content-start align-items-center w-100 mt-5">
                        <div class="slider-progress w-100">
                            <div class="slider-progress-bar"></div>
                        </div>
                    </div>
                </div>
            </div>
        {% endif %}
    </div>
    {% if not displayIndexLInk and pageUrl %}
        {% set btnLabel = entity.category.intl.placeholder is defined and entity.category.intl.placeholder ? entity.category.intl.placeholder : "Toutes les publications"|trans %}
        <div class="d-flex justify-content-center mt-5">
            {% include 'front/'~websiteTemplate~'/blocks/link/default.html.twig' with {
                intl: {
                    link: path('front_index', {url: pageUrl}),
                    linkStyle: 'btn btn-primary',
                    linkLabel: btnLabel,
                }
            } %}
        </div>
    {% endif %}
</div>