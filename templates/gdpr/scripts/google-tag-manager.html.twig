{% set website = website is defined and website ? website : website() %}

{% if website.api.google.tagManagerKey is defined and website.api.google.tagManagerKey %}
    {% set tagManagerKey = website.api.google.tagManagerKey %}
    <!-- Google Tag Manager -->
    <script class="analytics-script" nonce="{{ csp_nonce() }}">
        window.dataLayer = window.dataLayer || [];
        window.dataLayer.push({
            'cspNonce': '{{ csp_nonce() }}'
        });
        {% if not status %}
            function gtag(){ dataLayer.push(arguments); }
            // Consent Mode v2 — défaut refusé (avant chargement de GTM)
            gtag('consent', 'default', {
                'ad_storage': 'denied',
                'analytics_storage': 'denied',
                'functionality_storage': 'denied',
                'personalization_storage': 'denied',
                'security_storage': 'granted',
                'ad_user_data': 'denied',
                'ad_personalization': 'denied'
            });
        {% else %}
            {#gtag('consent', 'update', {#}
            {#    'analytics_storage': {{ consent.analytics ? "'granted'" : "'denied'" }},#}
            {#    'ad_storage': {{ consent.ads ? "'granted'" : "'denied'" }},#}
            {#    'personalization_storage': {{ consent.personalization ? "'granted'" : "'denied'" }},#}
            {#    'functionality_storage': {{ consent.functionality ? "'granted'" : "'denied'" }},#}
            {#    'ad_user_data': {{ consent.ads ? "'granted'" : "'denied'" }},#}
            {#    'ad_personalization': {{ consent.ads ? "'granted'" : "'denied'" }}#}
            {#});#}
        {% endif %}
        (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
                new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
            j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
            'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
        })(window,document,'script','dataLayer','{{ tagManagerKey }}');
    </script>
{% endif %}